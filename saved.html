<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cầu thủ đã lưu - FCO Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="saved.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#3b82f6">
</head>

<body>

    <header>
        <h1>Players List</h1>
        <div class="sub">Quản lý danh sách cầu thủ yêu thích của bạn</div>
    </header>

    <main style="display: block;">
        <!-- Override grid for this page to standard block or simplified layout -->

        <section class="card">
            <div class="card-header">
                <h2>Thêm mới</h2>
            </div>
            <div class="card-body">
                <div class="controls-grid" style="margin-bottom: 0;">
                    <div class="control-group" style="flex: 2;">
                        <label>Link cầu thủ (fo4players.com)</label>
                        <div class="input-group">
                            <input id="newPlayerLink" type="text" placeholder="Dán link từ fo4players.com..." />
                            <button class="btn btn-primary" id="btnAddNew">Thêm Cầu thủ</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="saved-table-container">
            <div class="table-responsive">
                <table id="savedTable">
                    <thead>
                        <tr>
                            <th>Tên cầu thủ</th>
                            <th>Tốc độ</th>
                            <th>Dứt điểm</th>
                            <th>Sức mạnh</th>
                            <th>Thăng bằng</th>
                            <th style="text-align: right;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="playerListBody">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                Chưa có cầu thủ nào được lưu.
            </div>
        </div>

    </main>

    <!-- Sidebar Script -->
    <script src="sidebar.js"></script>
    <!-- Use centralized data.js for ATTRS -->
    <script src="data.js"></script>

    <!-- Page Logic -->
    <script>
        // Utils to handle FO4 parsing (Simplified version of app.js logic)

        async function fetchFromProxy(url) {
            const proxies = [
                {
                    name: "AllOrigins (JSON)",
                    getUrl: (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&_=${Date.now()}`,
                    parse: (json) => json.contents
                },
                {
                    name: "AllOrigins (Raw)",
                    getUrl: (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                    parse: (text) => text
                },
                {
                    name: "Corsproxy.io",
                    getUrl: (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                    parse: (text) => text
                }
            ];

            let lastError = null;
            for (const proxy of proxies) {
                try {
                    const resp = await fetch(proxy.getUrl(url));
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    if (proxy.name.includes("AllOrigins (JSON)")) {
                        const json = await resp.json();
                        return proxy.parse(json);
                    } else {
                        return proxy.parse(await resp.text());
                    }
                } catch (err) {
                    lastError = err;
                    continue;
                }
            }
            throw new Error(lastError ? lastError.message : "Proxy error");
        }

        async function addNewPlayer() {
            const urlInput = document.getElementById('newPlayerLink');
            const btn = document.getElementById('btnAddNew');
            const url = (urlInput.value || "").trim();

            if (!url || !url.includes("fo4players.com")) {
                alert("Vui lòng nhập link hợp lệ từ fo4players.com");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Đang tải...";

            try {
                const html = await fetchFromProxy(url);

                // Parse name
                let name = "Unknown Player";
                const titleMatch = html.match(/<title>([^<|-]+)/);
                if (titleMatch) {
                    season = titleMatch[1].split("mùa")[1].trim().toUpperCase();
                    name = titleMatch[1].split("mùa")[0].trim() + " - " + season;
                }

                // Parse stats
                const stats = {};
                const regex = /<div class="text-shadow">([^<]+)<\/div>[\s\S]*?o-val="(\d+)"/g;
                let match;
                let count = 0;

                // Initialize empty from data.js ATTRS
                // Ensure data.js is loaded
                if (typeof ATTRS === 'undefined') {
                    throw new Error("Missing ATTRS definition");
                }

                ATTRS.forEach(a => stats[a] = { cs: null, bonus: null });

                while ((match = regex.exec(html)) !== null) {
                    const attrName = match[1].trim();
                    const val = parseInt(match[2]);
                    if (stats[attrName]) {
                        stats[attrName].cs = val;
                        stats[attrName].bonus = 0;
                        count++;
                    }
                }

                if (count === 0) {
                    throw new Error("Không tìm thấy chỉ số nào.");
                }

                // Save to localStorage
                const key = "fco_player_stats:" + name;
                localStorage.setItem(key, JSON.stringify(stats));

                alert(`Đã thêm cầu thủ: ${name}`);
                urlInput.value = "";
                renderList();

            } catch (err) {
                console.error(err);
                alert("Lỗi: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "Thêm Cầu thủ";
            }
        }

        function deletePlayer(key) {
            if (confirm("Bạn có chắc muốn xóa cầu thủ này?")) {
                localStorage.removeItem(key);
                renderList();
            }
        }

        function calcPlayer(key, name) {
            // We set a flag for index.html to read
            localStorage.setItem("fco_pending_load", name);
            window.location.href = "index.html";
        }

        function renderList() {
            const tbody = document.getElementById('playerListBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('savedTable');

            tbody.innerHTML = "";

            const players = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith("fco_player_stats:")) {
                    const name = key.replace("fco_player_stats:", "");
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        players.push({ key, name, data });
                    } catch (e) { }
                }
            }

            if (players.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            players.forEach(p => {
                const tr = document.createElement('tr');

                const speed = p.data['Tốc độ']?.cs || '-';
                const finish = p.data['Dứt điểm']?.cs || '-';
                const strength = p.data['Sức mạnh']?.cs || '-';
                const balance = p.data['Thăng bằng']?.cs || '-';

                tr.innerHTML = `
                    <td class="player-name-cell">${p.name}</td>
                    <td class="stat-cell">${speed}</td>
                    <td class="stat-cell">${finish}</td>
                    <td class="stat-cell">${strength}</td>
                     <td class="stat-cell">${balance}</td>
                    <td class="actions-cell">
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="calcPlayer('${p.key}', '${p.name}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                                Calc
                            </button>
                            <button class="btn btn-danger" onclick="deletePlayer('${p.key}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7c-1 0-2-1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('btnAddNew').addEventListener('click', addNewPlayer);
        document.addEventListener('DOMContentLoaded', renderList);

    </script>
</body>

</html>